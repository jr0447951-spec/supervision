<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>REPORTE CORTES - NIC AUTO</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-[#0f172a] text-white pb-16 font-sans text-[12px]">

    <div class="p-2 max-w-6xl mx-auto">
        <div id="capture-area" class="bg-white p-6 rounded shadow-2xl text-slate-900">
            
            <div class="text-center border-b-4 border-slate-800 pb-4 mb-4">
                <h1 class="text-3xl font-black tracking-tighter uppercase italic text-slate-800">Corte Programado</h1>
                <p class="text-lg font-bold text-slate-600 uppercase">Resumen de Operaciones - 22/02/2026</p>
            </div>

            <table class="w-full border-collapse border border-slate-400">
                <thead>
                    <tr class="bg-slate-800 text-white uppercase italic text-[10px]">
                        <th class="border border-slate-400 p-2 w-20">Distribuidora</th>
                        <th class="border border-slate-400 p-2 w-36">Horario</th>
                        <th class="border border-slate-400 p-2">Sitio / ID</th>
                        <th class="border border-slate-400 p-2 w-24">Torrero</th>
                        <th class="border border-slate-400 p-2">Comentario</th>
                        <th class="border border-slate-400 p-2 w-24">NIC</th>
                    </tr>
                </thead>
                <tbody id="tabla-cuerpo">
                    </tbody>
            </table>
        </div>

        <div class="mt-6 space-y-3 no-print">
            <div class="flex gap-2">
                <button onclick="addRow()" class="flex-1 bg-slate-700 p-4 rounded-xl font-bold uppercase hover:bg-slate-600 transition-all">ï¼‹ AÃ±adir Sitio</button>
                <button onclick="takeSnapshot()" class="flex-1 bg-white text-slate-900 p-4 rounded-xl font-bold uppercase shadow-lg">ðŸ“¸ Generar PNG</button>
            </div>
            <button onclick="downloadCSV()" class="w-full bg-emerald-600 p-4 rounded-xl font-bold uppercase">ðŸ“Š Exportar CSV</button>
        </div>
    </div>

    <template id="row-edit-temp">
        <tr class="fila-dato bg-white border-b border-slate-200">
            <td class="border border-slate-400 p-1">
                <select class="dist w-full outline-none font-bold uppercase bg-transparent">
                    <option value="AES">AES</option>
                    <option value="DELSUR">DELSUR</option>
                    <option value=" ">--</option>
                </select>
            </td>
            <td class="border border-slate-400 p-1">
                <input type="text" placeholder="8:30am - 4:30pm" class="horario w-full outline-none text-center font-semibold placeholder:text-slate-300">
            </td>
            <td class="border border-slate-400 p-1 relative">
                <input type="text" oninput="buscarSitio(this)" placeholder="Buscar..." class="sitio w-full outline-none uppercase font-bold placeholder:font-normal">
                <div class="sug-box hidden absolute left-0 bg-white border border-slate-400 w-full z-50 shadow-2xl max-h-40 overflow-y-auto"></div>
            </td>
            <td class="border border-slate-400 p-1">
                <input type="text" class="torrero w-full outline-none text-center uppercase italic text-slate-600 font-medium" readonly>
            </td>
            <td class="border border-slate-400 p-1">
                <input type="text" class="comentario w-full outline-none italic text-slate-700">
            </td>
            <td class="border border-slate-400 p-1">
                <input type="text" class="nic w-full outline-none text-center font-mono font-bold text-blue-700" readonly>
            </td>
        </tr>
    </template>

    <script>
        const CSV_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vTE_5CZtD7qHGW5cWHGAjn7ALTphVm5h88lco9cySYoAe2VBW4fq8DQ7-SZY6cd_FHtNQJS3MpE88hs/pub?output=csv';
        let dbSitios = [];

        // Carga de datos
        window.onload = () => {
            Papa.parse(CSV_URL, {
                download: true,
                header: false, // Usamos false para manejar Ã­ndices exactos
                complete: (results) => {
                    // Quitamos la cabecera del CSV
                    const rows = results.data.slice(1);
                    dbSitios = rows.map(row => ({
                        idNombre: `${row[0]} - ${row[1]}`, // Columna A y B
                        torrero: row[2],                  // Columna C (Propietario)
                        nic: row[4]                       // Columna E (Ãndice 4)
                    })).filter(item => item.idNombre.length > 5);
                    
                    for(let i=0; i<4; i++) addRow();
                }
            });
        };

        function addRow() {
            const body = document.getElementById('tabla-cuerpo');
            const temp = document.getElementById('row-edit-temp').content.cloneNode(true);
            body.appendChild(temp);
        }

        function buscarSitio(el) {
            const val = el.value.toLowerCase();
            const box = el.nextElementSibling;
            box.innerHTML = '';
            
            if(val.length < 2) {
                box.classList.add('hidden');
                return;
            }

            const filtered = dbSitios.filter(s => s.idNombre.toLowerCase().includes(val)).slice(0, 5);
            
            if(filtered.length > 0) {
                box.classList.remove('hidden');
                filtered.forEach(m => {
                    const d = document.createElement('div');
                    d.className = 'p-2 border-b hover:bg-slate-100 cursor-pointer text-[10px] uppercase font-bold text-slate-700';
                    d.innerText = m.idNombre;
                    d.onclick = () => {
                        const fila = el.closest('tr');
                        el.value = m.idNombre;
                        fila.querySelector('.torrero').value = m.torrero || "N/A";
                        fila.querySelector('.nic').value = m.nic || "S/N";
                        box.classList.add('hidden');
                    };
                    box.appendChild(d);
                });
            }
        }

        function takeSnapshot() {
            const area = document.getElementById('capture-area');
            const btns = document.querySelectorAll('.no-print');
            html2canvas(area, { scale: 3 }).then(canvas => {
                const link = document.createElement('a');
                link.download = `Reporte_Corte_${Date.now()}.png`;
                link.href = canvas.toDataURL("image/png");
                link.click();
            });
        }

        function downloadCSV() {
            let csvContent = "data:text/csv;charset=utf-8,";
            csvContent += "Distribuidora,Horario,Sitio,Torrero,Comentario,NIC\n";
            
            document.querySelectorAll('.fila-dato').forEach(row => {
                const data = [
                    row.querySelector('.dist').value,
                    row.querySelector('.horario').value,
                    row.querySelector('.sitio').value,
                    row.querySelector('.torrero').value,
                    row.querySelector('.comentario').value,
                    row.querySelector('.nic').value
                ].map(v => `"${v}"`).join(",");
                csvContent += data + "\n";
            });

            const encodedUri = encodeURI(csvContent);
            const link = document.createElement("a");
            link.setAttribute("href", encodedUri);
            link.setAttribute("download", "Corte_Programado.csv");
            document.body.appendChild(link);
            link.click();
        }
    </script>
</body>
</html>
