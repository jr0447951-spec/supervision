<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>SISTEMA OPERATIVO V16 - PRO</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;700;900&display=swap');
        body { font-family: 'Inter', sans-serif; background-color: #0f172a; color: #f1f5f9; touch-action: manipulation; }
        
        /* Ajustes de Tabla */
        .table-container { width: 100%; overflow-x: auto; background: white; border-radius: 12px; }
        table { width: 100%; min-width: 950px; border-collapse: collapse; table-layout: fixed; }
        th { background: #1e3a8a; color: white; font-size: 11px; padding: 12px 4px; border: 1px solid #334155; text-transform: uppercase; }
        td { border: 1px solid #cbd5e1; padding: 8px; color: #000; vertical-align: top; }

        /* Columnas */
        .col-dist { width: 75px; } .col-horario { width: 125px; } .col-sitio { width: 230px; }
        .col-torrero { width: 110px; } .col-nic { width: 95px; } .col-tech { width: 140px; }

        /* Modo Captura: Elimina espacios blancos y UI */
        .is-capturing { width: 1050px !important; padding: 0 !important; margin: 0 !important; }
        .is-capturing .no-print-ui { display: none !important; }
        .is-capturing .table-container { overflow: visible !important; border-radius: 0; width: 100% !important; }
        .is-capturing table { width: 100% !important; min-width: 100% !important; }
        
        .wrap-text { white-space: pre-wrap; word-break: break-word; font-size: 10px; }
        input, select, textarea { font-size: 14px !important; } /* Evita zoom en iOS */
    </style>
</head>
<body class="p-2 pb-24">

    <div id="modal-historial" class="fixed inset-0 bg-slate-900/98 z-[10000] hidden flex-col p-4">
        <div class="flex justify-between items-center mb-6">
            <h2 class="text-xl font-black text-amber-400 italic uppercase">Historial de Reportes</h2>
            <button onclick="cerrarHistorial()" class="text-white text-4xl">&times;</button>
        </div>
        <div class="flex gap-2 mb-6">
            <input type="date" id="fecha-filtro" class="flex-1 p-4 rounded-xl bg-slate-800 text-white border-2 border-slate-700 font-bold outline-none focus:border-amber-500">
            <button onclick="abrirHistorial()" class="flex-1 bg-white py-4 rounded-xl font-bold text-[10px] uppercase text-slate-900 shadow-lg border border-slate-200">
    <span style="filter: grayscale(1) contrast(2);">üìÖ</span> D√≠a
</button>
        </div>
        <div id="resultados-historial" class="flex-1 overflow-y-auto space-y-4 pb-10">
            <p class="text-center text-slate-500 italic mt-10">Ingresa una fecha para ver registros...</p>
        </div>
    </div>

    <div id="modal-tecnicos" class="fixed inset-0 bg-black/90 z-[9999] hidden items-center justify-center p-4">
        <div class="bg-white p-6 rounded-2xl w-full max-w-md shadow-2xl">
            <h3 class="font-black text-blue-900 mb-4 uppercase italic">Equipo T√©cnico</h3>
            <div id="lista-tecnicos" class="grid grid-cols-2 gap-2 mb-6 max-h-60 overflow-y-auto p-1"></div>
            <button onclick="cerrarModal()" class="w-full bg-blue-600 text-white py-4 rounded-xl font-black uppercase shadow-lg active:scale-95">Confirmar Equipo</button>
        </div>
    </div>

    <div class="max-w-full mx-auto">
        <div class="bg-slate-800 p-4 rounded-t-xl no-print-ui border-b border-slate-700">
            <input type="text" id="main-title" value="REPORTE DE CORTE - 25/02/2026" 
                   class="w-full text-center text-xl font-black uppercase italic bg-transparent text-blue-400 outline-none">
        </div>

        <div id="capture-area" class="bg-white">
            <div id="snap-header" class="hidden text-center py-6 border-b-4 border-blue-900 bg-white">
                <h1 id="title-display" class="text-3xl font-black uppercase italic text-blue-900"></h1>
            </div>

            <div class="table-container">
                <table>
                    <thead>
                        <tr>
                            <th class="col-dist">DIST.</th>
                            <th class="col-horario">HORARIO</th>
                            <th class="col-sitio">SITIO / ID</th>
                            <th class="col-torrero">TORRERO</th>
                            <th>COMENTARIO</th>
                            <th class="col-nic">NIC</th>
                            <th class="col-tech">ASIGNADO</th>
                        </tr>
                    </thead>
                    <tbody id="tabla-cuerpo"></tbody>
                </table>
            </div>
        </div>

        <div class="fixed bottom-0 left-0 right-0 p-3 bg-slate-900/95 backdrop-blur border-t border-slate-700 flex gap-2 no-print-ui z-50">
            <button onclick="addRow()" class="flex-1 bg-slate-700 py-4 rounded-xl font-bold text-[10px] uppercase text-white shadow-lg">Ôºã Fila</button>
            <button onclick="confirmAndSnapshot()" class="flex-1 bg-blue-600 py-4 rounded-xl font-bold text-[10px] uppercase text-white shadow-lg">üì∏ Foto</button>
            <button onclick="sendToSheets()" id="btn-save" class="flex-1 bg-emerald-600 py-4 rounded-xl font-bold text-[10px] uppercase text-white shadow-lg text-center">‚òÅÔ∏è Guardar</button>
            <button onclick="abrirHistorial()" class="flex-1 bg-amber-600 py-4 rounded-xl font-bold text-[10px] uppercase text-white shadow-lg">üìÖ D√≠a</button>
            <button onclick="clearAll()" class="bg-red-900/50 text-red-400 px-4 rounded-xl font-bold text-[10px] border border-red-800">DEL</button>
        </div>
    </div>

    <template id="row-temp">
        <tr class="fila-dato">
            <td class="text-center">
                <select class="dist w-full text-[11px] font-bold no-print-ui border p-1 bg-slate-50"><option value="">-</option><option value="AES">AES</option><option value="DELSUR">DELSUR</option></select>
                <div class="dist-val hidden font-black text-blue-900 text-[11px]"></div>
            </td>
            <td>
                <div class="no-print-ui flex flex-col gap-1">
                    <input type="time" class="h-in text-[10px] border p-1" onchange="processTime(this)">
                    <input type="time" class="h-out text-[10px] border p-1" onchange="processTime(this)">
                </div>
                <div class="horario-txt font-black text-[10px] text-center mt-1"></div>
            </td>
            <td class="relative">
                <input type="text" oninput="searchByName(this)" class="nombre-input w-full font-bold text-blue-800 text-[12px] no-print-ui border p-1" placeholder="Buscar sitio...">
                <div class="nombre-val hidden font-black text-blue-800 text-[11px] uppercase wrap-text leading-tight"></div>
                <div class="id-val text-[9px] font-bold text-slate-400 mt-1">ID: <span class="id-text text-slate-900">---</span></div>
                <div class="sug-box absolute hidden bg-white border-2 border-blue-600 w-full z-50 shadow-2xl max-h-48 overflow-y-auto"></div>
            </td>
            <td class="torrero-txt wrap-text font-bold text-slate-500 uppercase text-[10px] text-center">---</td>
            <td>
                <textarea class="comm-input w-full text-[10px] italic no-print-ui border p-1 bg-slate-50" rows="2" oninput="saveLocal()"></textarea>
                <div class="comm-val hidden wrap-text italic text-[10px] leading-tight"></div>
            </td>
            <td class="nic-txt font-mono font-black text-slate-900 text-[11px] text-center">---</td>
            <td>
                <button onclick="abrirModalTecnicos(this)" class="no-print-ui w-full bg-blue-50 text-[9px] font-bold border rounded p-1 mb-1">Ôºã EQUIPO</button>
                <div class="tech-display wrap-text text-[9px] font-bold text-slate-700 uppercase leading-tight"></div>
            </td>
        </tr>
    </template>

    <script>
        const SITES_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vTE_5CZtD7qHGW5cWHGAjn7ALTphVm5h88lco9cySYoAe2VBW4fq8DQ7-SZY6cd_FHtNQJS3MpE88hs/pub?output=csv';
        const WEBAPP_URL = 'ESCRIBE_AQUI_TU_URL_DE_APPS_SCRIPT'; 
        
        let dbSitios = [], dbTecnicos = ["TECNICO 1", "TECNICO 2", "TECNICO 3", "TECNICO 4"], currentTechRow = null;

        window.onload = () => {
            Papa.parse(SITES_URL, { download: true, complete: (r) => {
                dbSitios = r.data.slice(1).map(row => ({ id: row[0], name: row[1], owner: row[16], nic: row[4] })).filter(i => i.name);
                loadSaved();
            }});
            renderStaff();
        };

        function addRow() {
            const temp = document.getElementById('row-temp').content.cloneNode(true);
            document.getElementById('tabla-cuerpo').appendChild(temp);
            saveLocal();
        }

        function processTime(el) {
            const f = el.closest('tr'), i = f.querySelector('.h-in').value, o = f.querySelector('.h-out').value;
            const to12 = (v) => { if(!v) return ""; let [h, m] = v.split(':'); let a = h >= 12 ? 'PM' : 'AM'; h = h % 12 || 12; return `${h}:${m}${a}`; };
            if(i && o) f.querySelector('.horario-txt').innerText = `${to12(i)} A ${to12(o)}`;
            saveLocal();
        }

        function searchByName(el) {
            const val = el.value.toLowerCase(), box = el.nextElementSibling.nextElementSibling.nextElementSibling;
            box.innerHTML = '';
            if(val.length < 2) return box.classList.add('hidden');
            const matches = dbSitios.filter(s => s.name.toLowerCase().includes(val) || s.id.toLowerCase().includes(val)).slice(0, 6);
            matches.forEach(m => {
                const d = document.createElement('div');
                d.className = 'p-3 border-b text-[12px] font-bold hover:bg-blue-50';
                d.innerHTML = `<div class="flex justify-between"><span>${m.name}</span> <span class="text-blue-600">${m.id}</span></div>`;
                d.onclick = () => {
                    const f = el.closest('tr');
                    el.value = m.name;
                    f.querySelector('.nombre-val').innerText = m.name;
                    f.querySelector('.id-text').innerText = m.id;
                    f.querySelector('.torrero-txt').innerText = m.owner || "N/A";
                    f.querySelector('.nic-txt').innerText = m.nic || "S/N";
                    box.classList.add('hidden');
                    saveLocal();
                };
                box.appendChild(d);
            });
            box.classList.remove('hidden');
        }

        // --- HISTORIAL ---
        function abrirHistorial() { document.getElementById('modal-historial').classList.remove('hidden'); }
        function cerrarHistorial() { document.getElementById('modal-historial').classList.add('hidden'); }

        async function consultarPorDia() {
            const fechaInput = document.getElementById('fecha-filtro').value;
            if(!fechaInput) return alert("Selecciona fecha");
            const resBox = document.getElementById('resultados-historial');
            resBox.innerHTML = '<p class="text-amber-400 text-center animate-pulse">Consultando base de datos...</p>';
            
            try {
                const response = await fetch(WEBAPP_URL);
                const data = await response.json();
                const fechaBuscada = fechaInput.split('-').reverse().join('/'); // Convierte 2026-02-25 a 25/02/2026
                const filtrados = data.filter(f => f[0].toString().includes(fechaBuscada));
                
                resBox.innerHTML = filtrados.length ? '' : '<p class="text-slate-500 text-center">No hay registros para este d√≠a.</p>';
                filtrados.forEach(f => {
                    const d = document.createElement('div');
                    d.className = "bg-white p-4 rounded-xl text-slate-900 border-l-8 border-amber-500 shadow-lg";
                    d.innerHTML = `<div class="flex justify-between font-black text-blue-900"><span>${f[3]}</span> <span class="text-[10px] bg-slate-100 px-2 rounded">${f[2]}</span></div><div class="text-[10px] text-slate-500 font-bold uppercase mt-1">Equipo: ${f[5]}</div><div class="mt-2 text-[11px] italic border-t pt-2 text-slate-700">${f[6]}</div>`;
                    resBox.appendChild(d);
                });
            } catch(e) { alert("Error al conectar con la nube"); }
        }

        // --- CAPTURA ---
        function confirmAndSnapshot() {
            const area = document.getElementById('capture-area');
            const title = document.getElementById('main-title').value;
            document.getElementById('title-display').innerText = title;
            area.classList.add('is-capturing');
            
            document.querySelectorAll('.fila-dato').forEach(f => {
                f.querySelector('.dist-val').innerText = f.querySelector('.dist').value;
                f.querySelector('.dist-val').classList.remove('hidden');
                f.querySelector('.nombre-val').classList.remove('hidden');
                f.querySelector('.comm-val').innerText = f.querySelector('.comm-input').value;
                f.querySelector('.comm-val').classList.remove('hidden');
            });

            html2canvas(area, { scale: 2, backgroundColor: "#ffffff", width: 1050, onclone: (cloned) => {
                cloned.getElementById('snap-header').classList.remove('hidden');
            }}).then(canvas => {
                const link = document.createElement('a');
                link.download = `${title}.png`;
                link.href = canvas.toDataURL();
                link.click();
                area.classList.remove('is-capturing');
                document.querySelectorAll('.dist-val, .nombre-val, .comm-val').forEach(el => el.classList.add('hidden'));
            });
        }

        // --- ENV√çO INTELIGENTE (SUSTITUYE SI EXISTE) ---
        async function sendToSheets() {
            const btn = document.getElementById('btn-save');
            const fecha = document.getElementById('main-title').value;
            const rows = document.querySelectorAll('.fila-dato');
            if(rows.length === 0) return alert("Tabla vac√≠a");

            const payload = Array.from(rows).map(f => [
                fecha, f.querySelector('.dist').value, f.querySelector('.horario-txt').innerText,
                f.querySelector('.nombre-input').value, f.querySelector('.torrero-txt').innerText,
                f.querySelector('.tech-display').innerText, f.querySelector('.comm-input').value
            ]);

            try {
                btn.innerText = "ESPERE...";
                btn.disabled = true;
                await fetch(WEBAPP_URL, { method: 'POST', mode: 'no-cors', body: JSON.stringify(payload) });
                alert("‚úÖ DATOS ACTUALIZADOS\nSe han sustituido los registros anteriores de esta fecha.");
            } catch(e) { alert("‚ùå Error de red"); }
            finally { btn.innerText = "‚òÅÔ∏è GUARDAR"; btn.disabled = false; }
        }

        // --- APOYO ---
        function abrirModalTecnicos(btn) { currentTechRow = btn.closest('tr'); document.getElementById('modal-tecnicos').style.display = 'flex'; }
        function cerrarModal() {
            const sels = Array.from(document.querySelectorAll('.tech-chip.selected')).map(c => c.innerText);
            if(currentTechRow) currentTechRow.querySelector('.tech-display').innerText = sels.join(', ');
            document.getElementById('modal-tecnicos').style.display = 'none';
            document.querySelectorAll('.tech-chip').forEach(c => c.classList.remove('selected', 'bg-blue-600', 'text-white'));
            saveLocal();
        }
        function renderStaff() {
            const c = document.getElementById('lista-tecnicos');
            dbTecnicos.forEach(t => {
                const d = document.createElement('div'); d.className = "tech-chip p-3 border rounded-xl font-bold text-[11px] text-center uppercase bg-slate-50 active:bg-blue-100";
                d.innerText = t; d.onclick = function() { this.classList.toggle('selected'); this.classList.toggle('bg-blue-600'); this.classList.toggle('text-white'); };
                c.appendChild(d);
            });
        }
        function saveLocal() {
            const rows = Array.from(document.querySelectorAll('.fila-dato')).map(f => ({
                dist: f.querySelector('.dist').value, h: f.querySelector('.horario-txt').innerText, n: f.querySelector('.nombre-input').value,
                id: f.querySelector('.id-text').innerText, t: f.querySelector('.torrero-txt').innerText, c: f.querySelector('.comm-input').value,
                nic: f.querySelector('.nic-txt').innerText, st: f.querySelector('.tech-display').innerText
            }));
            localStorage.setItem('corte_v16_data', JSON.stringify({t: document.getElementById('main-title').value, r: rows}));
        }
        function loadSaved() {
            const s = JSON.parse(localStorage.getItem('corte_v16_data'));
            if(!s) return addRow();
            document.getElementById('main-title').value = s.t;
            s.r.forEach(r => {
                addRow(); const f = document.querySelector('.fila-dato:last-child');
                f.querySelector('.dist').value = r.dist; f.querySelector('.horario-txt').innerText = r.h;
                f.querySelector('.nombre-input').value = r.n; f.querySelector('.nombre-val').innerText = r.n;
                f.querySelector('.id-text').innerText = r.id; f.querySelector('.torrero-txt').innerText = r.t;
                f.querySelector('.comm-input').value = r.c; f.querySelector('.nic-txt').innerText = r.nic;
                f.querySelector('.tech-display').innerText = r.st;
            });
        }
        function clearAll() { if(confirm("¬øBorrar todo el reporte actual?")) { localStorage.removeItem('corte_v16_data'); location.reload(); } }
    </script>
</body>
</html>
